<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Registration</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* --- Your existing CSS --- */
    body {
      font-family: sans-serif;
      margin: 0;
      background-color: #f9f9f9;
      padding-top: 85px; /* ADJUST THIS VALUE based on your actual header height */
      min-height: 100vh;
      box-sizing: border-box;
    }

    /* --- HEADER STYLES --- */
    .app-header {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 100;
        width: 100%;
        background-color: #fff;
        padding: 15px 20px;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
    }

    .logo {
        height: 62px;
        width: auto;
        margin-right: 15px;
        flex-shrink: 0;
    }

    .header-text {
        display: flex;
        flex-direction: column;
    }

    .office-name {
        font-size: 16px;
        font-weight: 600;
        color: #222;
        margin: 0 0 4px 0;
    }

    .office-address {
        font-size: 13px;
        color: #666;
        margin: 0;
        line-height: 1.4;
    }
    /* --- END HEADER STYLES --- */


    .container {
      width: 100%;
      max-width: 400px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.08);
      padding: 20px 20px 25px 20px;
      box-sizing: border-box;
      position: relative;
      margin: 20px auto;
    }

    h2 { /* Form title */
      font-size: 24px;
      font-weight: bold;
      color: #222;
      margin-top: 0;
      margin-bottom: 10px;
      text-align: center;
    }

    .subtitle {
        font-size: 15px;
        color: #777;
        margin-bottom: 30px;
        text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    /* --- Field Title (Label) Font Size --- */
    label, .form-label {
      display: block;
      font-size: 15px;  /* <<< Standard mobile size (increased slightly) */
      color: #555;
      margin-bottom: 8px;
    }

    .required {
        color: #FF6600;
        margin-left: 3px;
        font-weight: bold;
    }

    /* --- Input/Select/Textarea Font Size --- */
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px 15px;
      font-size: 16px; /* <<< Standard 16px for mobile input */
      border: 1px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      outline: none;
      background-color: #fff;
      color: #333;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      font-family: inherit;
    }

    /* --- Placeholder Font Size --- */
    input::placeholder,
    textarea::placeholder {
        color: #aaa;
        font-size: inherit; /* <<< Inherits 16px from input/textarea */
        /* font-style: italic; */ /* Optional */
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      border-color: #FF6600;
    }

    /* --- Select Box Placeholder Text --- */
    select {
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23999999%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 12px auto;
        padding-right: 40px;
    }
    /* Styles the select box when the default disabled option is selected */
    select:required:invalid {
      color: #aaa; /* <<< Placeholder color */
      /* font-style: italic; */ /* Optional */
    }
    select option[value=""][disabled] {
      display: none; /* Hide the placeholder option from dropdown */
    }
     select option {
      color: #333; /* Normal text color for dropdown options */
    }

    textarea {
        resize: vertical;
        min-height: 80px;
    }

    .hidden {
        display: none;
    }
    .mt-2 {
        margin-top: 10px;
    }
    .form-hint {
        font-size: 12px;
        color: #888;
        margin-top: 5px;
    }

    .first-visit-checkbox-group {
        display: flex;
        align-items: center;
        margin-top: 5px;
        margin-bottom: 25px;
    }
    .first-visit-checkbox-group input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
        accent-color: #FF6600;
        height: 16px;
        width: 16px;
        cursor: pointer;
         appearance: none;
         -webkit-appearance: none;
         -moz-appearance: none;
         border: 1px solid #ccc;
         border-radius: 3px;
         position: relative;
         top: 1px;
    }
     .first-visit-checkbox-group input[type="checkbox"]:checked {
         background-color: #FF6600;
         border-color: #FF6600;
     }
     .first-visit-checkbox-group input[type="checkbox"]:checked::before {
         content: '\2714';
         font-size: 12px;
         color: white;
         position: absolute;
         left: 50%;
         top: 50%;
         transform: translate(-50%, -50%);
     }
    .first-visit-checkbox-group label {
        margin-bottom: 0;
        display: flex;
        align-items: center;
        cursor: pointer;
        color: #555;
        /* Use label's standard font size */
        font-size: 15px;
    }
    .first-visit-checkbox-group span {
        line-height: 1;
    }

    .signature-group {
        margin-bottom: 20px;
    }
    .canvas-container {
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 10px;
        position: relative;
        cursor: crosshair;
        overflow: hidden;
    }
    #signatureCanvas {
        display: block;
        width: 100%;
        height: 150px;
        background-color: #fdfdfd;
    }
    .clear-btn {
        padding: 8px 15px;
        font-size: 14px;
        color: #555;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .clear-btn:hover {
        background-color: #e0e0e0;
    }
    #signatureData {
        display: none;
    }
    #sigError {
        color: #D8000C;
        font-size: 12px;
        margin-top: 5px;
    }
     .canvas-container.error-border {
         border-color: #D8000C;
     }
     .error-message { /* Style for JS-added error messages */
        color: #D8000C;
        font-size: 12px;
        margin-top: 4px;
     }


    .button-primary {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
      background-color: #FF6600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      margin-top: 15px;
    }
    .button-primary:hover:not(:disabled) { /* Add :not(:disabled) */
      background-color: #E65C00;
    }
    .button-primary:disabled { /* Style for disabled state */
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

  </style>

  <!-- ****** ADD SUPABASE JS LIBRARY ****** -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- ****** END SUPABASE JS LIBRARY ****** -->

</head>
<body>

  <!-- ****** FIXED HEADER ****** -->
  <header class="app-header">
    <!-- Make sure 'dict logo.png' is in the same directory or provide the correct path -->
    <img src="dict logo.png" alt="Office Logo" class="logo">
    <div class="header-text">
        <h3 class="office-name">Department of Information and Communications Technology</h3>
        <p class="office-address">Surigao del Norte Provincial Office</p>
    </div>
  </header>
  <!-- ****** END HEADER ****** -->


  <div class="container">

    <h2>Visitors Registration</h2>
    <p class="subtitle">Please fill out the visitor information form</p>

    <!-- Removed action="#" and method="POST" -->
    <form id="registrationForm" onsubmit="handleSubmit(event)">

        <!-- 1. Full Name -->
        <div class="form-group">
            <label for="fullName" class="form-label">Full Name <span class="required">*</span></label>
            <input type="text" id="fullName" name="fullName" required placeholder="Enter your full name">
        </div>

        <!-- 2. Sex -->
        <div class="form-group">
            <label for="sex" class="form-label">Sex <span class="required">*</span></label>
            <select id="sex" name="sex" required>
                <option value="" disabled selected>Select Sex</option> <!-- Placeholder text -->
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Prefer not to say">Prefer not to say</option>
            </select>
        </div>

        <!-- 3. Age -->
        <div class="form-group">
             <label for="age" class="form-label">Age <span class="required">*</span></label>
             <input type="number" id="age" name="age" min="0" max="120" required placeholder="Enter your age">
        </div>

        <!-- 4. Services Availed -->
        <div class="form-group">
            <label for="services_availed" class="form-label">Services Availed <span class="required">*</span></label>
            <select id="services_availed" name="services_availed" required onchange="toggleOtherService(this.value)">
                <option value="" disabled selected>Select service</option> <!-- Placeholder text -->
                <option value="Free Wi-Fi for All (FW4A)">Free Wi-Fi for All (FW4A)</option>
                <option value="Tech4ED-DTC Program">Tech4ED-DTC Program</option>
                <option value="Cybersecurity Awareness and PNPKI Services">Cybersecurity Awareness and PNPKI Services</option>
                <option value="ICT Training and Capacity Building">ICT Training and Capacity Building</option>
                <option value="Government Network (GovNet) Connectivity">Government Network (GovNet) Connectivity</option>
                <option value="Smart Villages, Smart Islands (SVSI) Initiative">Smart Villages, Smart Islands (SVSI) Initiative</option>
                <option value="National Broadband Program (NBP)">National Broadband Program (NBP)</option>
                <option value="DICT Digital Governance (eGov Services)">DICT Digital Governance (eGov Services)</option>
                <option value="ICT Industry Development">ICT Industry Development</option>
                <option value="Technical Support">Technical Support</option>
                <option value="Others">Others</option>
            </select>
            <!-- 5. Other Service (Conditional) -->
            <div id="other_service_div" class="mt-2 hidden">
                <label for="other_service" class="visually-hidden">Other Service Specification</label>
                <input type="text" id="other_service" name="other_service" placeholder="Please specify other service">
                <p class="form-hint">Provide details if you selected "Others"</p>
                 <div class="error-message"></div> <!-- Placeholder for JS error -->
            </div>
        </div>

        <!-- 6. Sector -->
         <div class="form-group">
            <label for="sector" class="form-label">Sector <span class="required">*</span></label>
            <select id="sector" name="sector" required>
                <option value="" disabled selected>Select your sector</option> <!-- Placeholder text -->
                <option value="Out-of-School Youth & Adults">Out-of-School Youth & Adults</option>
                <option value="Educators">Educators</option>
                <option value="Students">Students</option>
                <option value="People with Disabilities">People with Disabilities</option>
                <option value="Women">Women</option>
                <option value="Senior Citizens">Senior Citizens</option>
                <option value="Overseas Filipino Workers (OFWs) and Their Families/Relatives">Overseas Filipino Workers (OFWs) and Their Families/Relatives</option>
                <option value="Entrepreneurs">Entrepreneurs</option>
                <option value="Indigenous Peoples">Indigenous Peoples</option>
                <option value="Farmers and Fisherfolk">Farmers and Fisherfolk</option>
                <option value="Government Employees & Public Servants">Government Employees & Public Servants</option>
                <option value="Micro, Small, and Medium Enterprises (MSMEs)">Micro, Small, and Medium Enterprises (MSMEs)</option>
                <option value="Health Workers & Medical Professionals">Health Workers & Medical Professionals</option>
                <option value="Transport & Logistics Workers">Transport & Logistics Workers</option>
                <option value="Informal Workers & Daily Wage Earners">Informal Workers & Daily Wage Earners</option>
            </select>
         </div>

        <!-- 7. Experience Rating -->
        <div class="form-group">
             <label for="rating" class="form-label">Experience Rating <span class="required">*</span></label>
             <select id="rating" name="rating" required>
                 <option value="" disabled selected>Rate your experience</option> <!-- Placeholder text -->
                 <option value="4">Very Satisfied (4)</option>
                 <option value="3">Satisfied (3)</option>
                 <option value="2">Neutral (2)</option>
                 <option value="1">Unsatisfied (1)</option>
             </select>
        </div>

        <!-- 8. Recommendations/Comments -->
        <div class="form-group">
             <label for="recommendations" class="form-label">Recommendations/Comments</label>
             <textarea id="recommendations" name="recommendations" rows="3" placeholder="Any suggestions or feedback? (Optional)"></textarea>
        </div>

         <!-- 10. First Time Visit -->
        <div class="form-group first-visit-checkbox-group">
            <label>
                <input type="checkbox" name="is_first_visit" id="isFirstVisit" value="true">
                <span>This is my first visit</span>
            </label>
        </div>

        <!-- 9. Signature Data -->
        <div class="form-group signature-group">
            <label for="signatureCanvas" class="form-label">Signature <span class="required">*</span></label> <!-- Added required indicator -->
            <div class="canvas-container" id="canvasContainer">
               <canvas id="signatureCanvas"></canvas>
            </div>
             <button type="button" id="clearSignatureBtn" class="clear-btn">Clear Signature</button>
             <input type="hidden" id="signatureData" name="signatureData">
             <div id="sigError"></div> <!-- Placeholder for JS error -->
        </div>

        <!-- Submit Button -->
        <button type="submit" id="submitButton" class="button-primary">Register Client</button>

    </form>

  </div><!-- end .container -->

  <!-- ****** JAVASCRIPT CODE ****** -->
  <script>
    // --- Supabase Setup ---
    const SUPABASE_URL = 'https://uqurpcrlrcgdrhsfkbtj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxdXJwY3JscmNnZHJoc2ZrYnRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMyMTEyNDcsImV4cCI6MjA1ODc4NzI0N30.JUQa7VXnG20LXCco7QxRMi1yFS1g7e1ojBuQOb9OZIU';

    // Initialize Supabase Client
    let supabase; // Declare variable to hold the client later

    try {
        // Check if the Supabase library loaded and exposed the global 'supabase' object
        // Use window.supabase to be explicit about checking the global scope
        if (typeof window.supabase === 'undefined' || typeof window.supabase.createClient !== 'function') {
            // Throw an error if the library or the createClient function isn't available
            throw new Error("Supabase library not loaded correctly or 'createClient' function is missing.");
        }

        // NOW, call createClient on the global object and assign the result
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("Supabase client initialized successfully.");

    } catch (error) {
        console.error("Error initializing Supabase:", error); // Log the specific error
        alert("Error connecting to the database. Please check the console and contact support.");
         const submitBtn = document.getElementById('submitButton');
         if(submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Connection Error';
         }
         // Ensure supabase is null if initialization fails, preventing further errors
         supabase = null;
    }


    // --- Form Submission Handling ---
    async function handleSubmit(event) {
        event.preventDefault();
        // The check !supabase is now more reliable here
        if (!supabase) {
            alert('Database connection is not available. Cannot submit form.');
            console.error('handleSubmit called but Supabase client is not initialized.');
            return;
        }

        const submitButton = document.getElementById('submitButton');
        const form = event.target; // Get the form element

        let isValid = true;
        const sigError = document.getElementById('sigError');
        const canvasContainer = document.getElementById('canvasContainer');
        const servicesSelect = document.getElementById('services_availed');
        const otherServiceInput = document.getElementById('other_service');
        const otherServiceGroup = otherServiceInput.closest('#other_service_div');
        let otherServiceErrorMsg = otherServiceGroup.querySelector('.error-message');

        // Clear previous errors first
        sigError.textContent = '';
        canvasContainer.classList.remove('error-border');
        if(otherServiceErrorMsg) otherServiceErrorMsg.textContent = '';
        otherServiceInput.style.borderColor = '#ddd'; // Reset border color


        // Capture signature before validation
        if (!isCanvasBlank(document.getElementById('signatureCanvas'))) {
             captureSignature();
        } else {
             // Explicitly clear signature data if canvas is blank AFTER trying to draw
             signatureDataInput.value = '';
        }

        // --- Start Validation ---

        // Validate Signature (must not be empty after capture attempt)
        const signatureDataInput = document.getElementById('signatureData');
        if (!signatureDataInput.value) {
            sigError.textContent = 'Signature is required.';
            canvasContainer.classList.add('error-border');
            isValid = false;
        }

        // Validate 'Other Service' text input if 'Others' selected
        if (servicesSelect.value === 'Others' && !otherServiceInput.value.trim()) {
             if (!otherServiceErrorMsg) { // Add error div if somehow missing
                 otherServiceErrorMsg = document.createElement('div');
                 otherServiceErrorMsg.className = 'error-message';
                 otherServiceGroup.appendChild(otherServiceErrorMsg);
             }
             otherServiceErrorMsg.textContent = 'Please specify the "Other Service".';
             otherServiceInput.style.borderColor = '#D8000C';
             isValid = false;
        }

        // --- Handle Validation Result ---
        if (isValid) {
            submitButton.disabled = true;
            submitButton.textContent = 'Registering...';

            // Prepare data for Supabase (use snake_case for keys matching table columns)
            const formData = new FormData(form);
            const registrationData = {
                full_name: formData.get('fullName'),
                sex: formData.get('sex'),
                age: parseInt(formData.get('age'), 10), // Ensure age is an integer
                services_availed: formData.get('services_availed'),
                other_service: formData.get('services_availed') === 'Others' ? formData.get('other_service').trim() : null,
                sector: formData.get('sector'),
                rating: parseInt(formData.get('rating'), 10), // Ensure rating is an integer
                recommendations: formData.get('recommendations').trim() || null,
                is_first_visit: document.getElementById('isFirstVisit').checked, // Boolean value
                signature_data: formData.get('signatureData') // The base64 Data URL string
            };

            console.log("Attempting to submit to Supabase:", registrationData);

            try {
                // Insert data into the 'visitors' table (MAKE SURE 'visitors' IS YOUR TABLE NAME)
                const { data, error } = await supabase
                    .from('visitors') // Confirm this table name exists in your Supabase project
                    .insert([registrationData])
                    .select(); // Optional: get the inserted row back

                if (error) {
                    // Throw the error to be caught by the catch block
                    console.error('Supabase insert error:', error); // Log the detailed error
                    throw new Error(`Database Error: ${error.message} (Hint: ${error.hint || 'Check table name and RLS policies'})`); // Provide more context in alert
                }

                // Success!
                console.log('Supabase insert success:', data);
                alert('Registration Successful!');
                form.reset(); // Reset the form fields
                clearSignature(); // Clear the signature canvas
                toggleOtherService(''); // Reset conditional field
                // Ensure error messages are cleared on successful reset
                sigError.textContent = '';
                canvasContainer.classList.remove('error-border');
                if(otherServiceErrorMsg) otherServiceErrorMsg.textContent = '';
                otherServiceInput.style.borderColor = '#ddd';


            } catch (error) {
                // Handle Supabase error or other errors during submission
                console.error('Submission error:', error);
                alert(`Registration failed: ${error.message}`);
                // Keep form data populated for user to retry/fix if needed
            } finally {
                // Re-enable the button whether success or failure
                submitButton.disabled = false;
                submitButton.textContent = 'Register Client';
            }

        } else {
             console.log('Form validation failed.');
             // Scroll to the first error field
             const firstErrorField = document.querySelector('.error-border, input[style*="border-color: rgb(216, 0, 12)"], select[style*="border-color: rgb(216, 0, 12)"]'); // Include select
             if (firstErrorField) {
                // Scroll the element into view, centered vertically
                firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Attempt to focus the element after scrolling (preventing the focus scroll jump)
                // Small delay might help ensure scrolling is finished
                setTimeout(() => {
                    if (firstErrorField.tagName === 'INPUT' || firstErrorField.tagName === 'SELECT' || firstErrorField.tagName === 'TEXTAREA' || firstErrorField.id === 'canvasContainer') {
                        if(firstErrorField.id === 'canvasContainer') {
                            // Maybe focus the clear button or just leave it scrolled
                        } else {
                            firstErrorField.focus({ preventScroll: true });
                        }
                    }
                }, 150); // Adjust delay if needed
             }
             // Optionally show a general validation error message
             // alert("Please fix the errors highlighted in the form.");
        }
    }

    // --- Conditional 'Other Service' Field ---
    function toggleOtherService(selectedValue) {
        const otherServiceDiv = document.getElementById('other_service_div');
        const otherServiceInput = document.getElementById('other_service');
        const otherServiceErrorMsg = otherServiceDiv.querySelector('.error-message');

        if (selectedValue === 'Others') {
            otherServiceDiv.classList.remove('hidden');
            otherServiceInput.required = true; // Keep JS validation consistent
        } else {
            otherServiceDiv.classList.add('hidden');
            otherServiceInput.required = false;
            otherServiceInput.value = ''; // Clear value when hiding
            // Clear errors when hiding
            if (otherServiceErrorMsg) otherServiceErrorMsg.textContent = '';
            otherServiceInput.style.borderColor = '#ddd';
        }
    }

    // --- Signature Pad Logic ---
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const clearButton = document.getElementById('clearSignatureBtn');
    const signatureDataInput = document.getElementById('signatureData');
    const sigError = document.getElementById('sigError');
    const canvasContainer = document.getElementById('canvasContainer');

    let drawing = false;
    let lastX = 0;
    let lastY = 0;

    // Set initial line properties
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#333';

    function resizeCanvas() {
        const rect = canvas.parentElement.getBoundingClientRect();
        const width = Math.max(1, rect.width);
        const height = 150; // Fixed height

        // Only resize if dimensions actually change
        if (canvas.width !== width || canvas.height !== height) {
            canvas.width = width;
            canvas.height = height;

            // Re-apply context settings as they are reset on resize
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#333';

            // Clear signature data if canvas was cleared by resize
            clearSignature(false); // Don't clear existing error state on resize
        }
    }


    function getMousePos(canvasDom, event) {
        var rect = canvasDom.getBoundingClientRect();
        return {
            x: event.clientX - rect.left,
            y: event.clientY - rect.top
        };
    }

    function getTouchPos(canvasDom, touchEvent) {
        var rect = canvasDom.getBoundingClientRect();
        return (touchEvent.touches && touchEvent.touches.length > 0) ? {
             x: touchEvent.touches[0].clientX - rect.left,
             y: touchEvent.touches[0].clientY - rect.top
        } : { x: lastX, y: lastY }; // Fallback
    }

    function startDrawing(e) {
        if (e.touches) e.preventDefault();

        if (canvas.width <= 0 || canvas.height <= 0) {
            resizeCanvas();
             if (canvas.width <= 0 || canvas.height <= 0) {
                 console.error("Cannot draw on zero/invalid-dimension canvas.");
                 return;
             }
        }

        drawing = true;
        const pos = (e.touches) ? getTouchPos(canvas, e) : getMousePos(canvas, e);
        [lastX, lastY] = [pos.x, pos.y];

        // Clear signature error display when user starts drawing again
        sigError.textContent = '';
        canvasContainer.classList.remove('error-border');
        signatureDataInput.value = ''; // Clear hidden input until drawing stops
    }


    function draw(e) {
        if (!drawing) return;
        if (e.touches) e.preventDefault();

        const pos = (e.touches) ? getTouchPos(canvas, e) : getMousePos(canvas, e);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        [lastX, lastY] = [pos.x, pos.y];
    }

    function stopDrawing() {
        if (drawing) {
            drawing = false;
            captureSignature(); // Capture signature data *after* drawing stops
        }
    }

     function captureSignature() {
        if (!isCanvasBlank(canvas)) {
             try {
                signatureDataInput.value = canvas.toDataURL('image/png');
             } catch(e) {
                 console.error("Error capturing signature:", e);
                 sigError.textContent = "Could not capture signature image.";
                 canvasContainer.classList.add('error-border');
                 signatureDataInput.value = ''; // Ensure value is cleared on error
             }
        } else {
             signatureDataInput.value = ''; // Ensure hidden input is empty if canvas is blank
        }
     }

    function clearSignature(clearErrorState = true) {
        if(ctx) {
             ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        signatureDataInput.value = ''; // Clear the hidden input
        if (clearErrorState) {
             sigError.textContent = ''; // Clear any validation error message
             canvasContainer.classList.remove('error-border'); // Remove error styling
        }
    }

    function isCanvasBlank(canvasToCheck) {
         if (!canvasToCheck || canvasToCheck.width === 0 || canvasToCheck.height === 0) {
             return true;
         }
         try {
            const pixelBuffer = new Uint32Array(
                ctx.getImageData(0, 0, canvasToCheck.width, canvasToCheck.height).data.buffer
            );
            return !pixelBuffer.some(color => color !== 0);
         } catch (e) {
             console.error("Canvas inspection failed:", e);
             // If we can't inspect, cautiously assume it's not blank if user interacted
             return false;
         }
    }

    // --- Event Listeners ---
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    canvas.addEventListener('touchstart', startDrawing, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', stopDrawing);

    clearButton.addEventListener('click', () => clearSignature(true));

    // --- Initial Setup ---
    window.addEventListener('load', () => {
         resizeCanvas(); // Size canvas correctly on load
         toggleOtherService(document.getElementById('services_availed').value); // Set initial state

         // Ensure error message div exists for 'Other Services'
         const otherServiceDiv = document.getElementById('other_service_div');
         if (!otherServiceDiv.querySelector('.error-message')) {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'error-message';
            otherServiceDiv.appendChild(errorMsg);
         }
    });

    // Adjust canvas size on window resize
    window.addEventListener('resize', resizeCanvas);

  </script>

</body>
</html>
