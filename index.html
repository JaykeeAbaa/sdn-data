<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Registration</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background-color: #f9f9f9;
      padding-top: 85px; /* Adjust based on header height */
      min-height: 100vh;
      box-sizing: border-box;
    }

    /* --- HEADER STYLES --- */
    .app-header {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 100;
        width: 100%;
        background-color: #fff;
        padding: 15px 20px;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        height: 85px; /* Example fixed height */
    }

    .logo {
        height: 55px;
        width: auto;
        margin-right: 15px;
        flex-shrink: 0;
    }

    .header-text {
        display: flex;
        flex-direction: column;
    }

    .office-name {
        font-size: 16px;
        font-weight: 600;
        color: #222;
        margin: 0 0 4px 0;
    }

    .office-address {
        font-size: 13px;
        color: #666;
        margin: 0;
        line-height: 1.4;
    }
    /* --- END HEADER STYLES --- */

    .container {
      width: 100%;
      max-width: 400px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.08);
      padding: 20px 20px 25px 20px;
      box-sizing: border-box;
      position: relative;
      margin: 20px auto;
    }

    h2 { /* Form title */
      font-size: 24px;
      font-weight: bold;
      color: #222;
      margin-top: 0;
      margin-bottom: 10px;
      text-align: center;
    }

    .subtitle {
        font-size: 15px;
        color: #777;
        margin-bottom: 30px;
        text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label, .form-label {
      display: block;
      font-size: 15px;
      color: #555;
      margin-bottom: 8px;
    }

    .required {
        color: #FF6600;
        margin-left: 3px;
        font-weight: bold;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px 15px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      outline: none;
      background-color: #fff;
      color: #333;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      font-family: inherit;
    }

    input::placeholder,
    textarea::placeholder {
        color: #aaa;
        font-size: inherit;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      border-color: #FF6600;
    }

    select {
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23999999%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 12px auto;
        padding-right: 40px;
    }
    select:required:invalid {
      color: #aaa;
    }
    select option[value=""][disabled] {
      display: none;
    }
     select option {
      color: #333;
    }

    textarea {
        resize: vertical;
        min-height: 80px;
    }

    .hidden {
        display: none;
    }
    .mt-2 {
        margin-top: 10px;
    }
    .form-hint {
        font-size: 12px;
        color: #888;
        margin-top: 5px;
    }

    .first-visit-checkbox-group {
        display: flex;
        align-items: center;
        margin-top: 5px;
        margin-bottom: 25px;
    }
    .first-visit-checkbox-group input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
        accent-color: #FF6600;
        height: 16px;
        width: 16px;
        cursor: pointer;
         appearance: none;
         -webkit-appearance: none;
         -moz-appearance: none;
         border: 1px solid #ccc;
         border-radius: 3px;
         position: relative;
         top: 1px;
    }
     .first-visit-checkbox-group input[type="checkbox"]:checked {
         background-color: #FF6600;
         border-color: #FF6600;
     }
     .first-visit-checkbox-group input[type="checkbox"]:checked::before {
         content: '\2714'; /* Checkmark */
         font-size: 12px;
         color: white;
         position: absolute;
         left: 50%;
         top: 50%;
         transform: translate(-50%, -50%);
     }
    .first-visit-checkbox-group label {
        margin-bottom: 0;
        display: flex;
        align-items: center;
        cursor: pointer;
        color: #555;
        font-size: 15px;
    }
    .first-visit-checkbox-group span {
        line-height: 1;
    }

    .signature-group {
        margin-bottom: 20px;
    }
    .canvas-container {
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 10px;
        position: relative;
        cursor: crosshair;
        overflow: hidden;
        line-height: 0;
    }
    #signatureCanvas {
        display: block;
        width: 100%;
        height: 150px;
        background-color: #fdfdfd;
    }
    .clear-btn {
        padding: 8px 15px;
        font-size: 14px;
        color: #555;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .clear-btn:hover {
        background-color: #e0e0e0;
    }
    #signatureData {
        display: none;
    }
    #sigError {
        color: #D8000C;
        font-size: 12px;
        margin-top: 5px;
        min-height: 15px;
    }
     .canvas-container.error-border,
     input.error-border,
     select.error-border,
     textarea.error-border {
         border-color: #D8000C !important;
     }
     .error-message {
        color: #D8000C;
        font-size: 12px;
        margin-top: 4px;
        min-height: 15px;
     }


    .button-primary {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
      background-color: #FF6600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.2s ease, opacity 0.2s ease; /* Added opacity transition */
      margin-top: 15px;
    }
    .button-primary:hover {
      background-color: #E65C00;
    }
    .button-primary:disabled { /* Style for disabled state */
        background-color: #FFCC99; /* Lighter orange */
        cursor: wait;
        opacity: 0.7;
    }

    .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    #formStatus { /* Style for the status message */
        margin-top: 15px;
        text-align: center;
        font-weight: bold;
        min-height: 20px; /* Reserve space */
    }
    #formStatus.success { color: green; }
    #formStatus.error { color: red; }
    #formStatus.submitting { color: #555; } /* Neutral color */

  </style>
</head>
<body>

  <!-- ****** FIXED HEADER ****** -->
  <header class="app-header">
    <!-- Make sure the logo path is correct relative to your HTML file -->
    <img src="dict logo.png" alt="Office Logo" class="logo">
    <div class="header-text">
        <h3 class="office-name">Department of Information and Communications Technology</h3>
        <p class="office-address">Surigao del Norte Provincial Office</p>
    </div>
  </header>
  <!-- ****** END HEADER ****** -->


  <div class="container">

    <h2>Client Registration</h2>
    <p class="subtitle">Please provide your details below</p>

    <!-- Ensure the onsubmit handler calls the correct function -->
    <form id="registrationForm" onsubmit="return handleSubmit(event)">

        <!-- 1. Full Name -->
        <div class="form-group">
            <label for="fullName" class="form-label">Full Name <span class="required">*</span></label>
            <input type="text" id="fullName" name="fullName" required placeholder="Enter your full name">
            <div class="error-message"></div>
        </div>

        <!-- 2. Sex -->
        <div class="form-group">
            <label for="sex" class="form-label">Sex <span class="required">*</span></label>
            <select id="sex" name="sex" required>
                <option value="" disabled selected>Select Sex</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Prefer not to say">Prefer not to say</option>
            </select>
             <div class="error-message"></div>
        </div>

        <!-- 3. Age -->
        <div class="form-group">
             <label for="age" class="form-label">Age <span class="required">*</span></label>
             <input type="number" id="age" name="age" min="1" max="120" required placeholder="Enter your age">
             <div class="error-message"></div>
        </div>

        <!-- 4. Services Availed -->
        <div class="form-group">
            <label for="services_availed" class="form-label">Services Availed <span class="required">*</span></label>
            <select id="services_availed" name="services_availed" required>
                <option value="" disabled selected>Select service</option>
                <option value="Free Wi-Fi for All (FW4A)">Free Wi-Fi for All (FW4A)</option>
                <option value="Tech4ED-DTC Program">Tech4ED-DTC Program</option>
                <option value="Cybersecurity Awareness and PNPKI Services">Cybersecurity Awareness and PNPKI Services</option>
                <option value="ICT Training and Capacity Building">ICT Training and Capacity Building</option>
                <option value="Government Network (GovNet) Connectivity">Government Network (GovNet) Connectivity</option>
                <option value="Smart Villages, Smart Islands (SVSI) Initiative">Smart Villages, Smart Islands (SVSI) Initiative</option>
                <option value="National Broadband Program (NBP)">National Broadband Program (NBP)</option>
                <option value="DICT Digital Governance (eGov Services)">DICT Digital Governance (eGov Services)</option>
                <option value="ICT Industry Development">ICT Industry Development</option>
                <option value="Technical Support">Technical Support</option>
                <option value="Others">Others</option>
            </select>
             <div class="error-message"></div>
            <!-- 5. Other Service (Conditional) -->
            <div id="other_service_div" class="mt-2 hidden">
                <label for="other_service" class="visually-hidden">Other Service Specification</label>
                <input type="text" id="other_service" name="other_service" placeholder="Please specify other service">
                <p class="form-hint">Provide details if you selected "Others"</p>
                 <div class="error-message"></div>
            </div>
        </div>

        <!-- 6. Sector -->
         <div class="form-group">
            <label for="sector" class="form-label">Sector <span class="required">*</span></label>
            <select id="sector" name="sector" required>
                <option value="" disabled selected>Select your sector</option>
                <option value="Out-of-School Youth & Adults">Out-of-School Youth & Adults</option>
                <option value="Educators">Educators</option>
                <option value="Students">Students</option>
                <option value="People with Disabilities">People with Disabilities</option>
                <option value="Women">Women</option>
                <option value="Senior Citizens">Senior Citizens</option>
                <option value="Overseas Filipino Workers (OFWs) and Their Families/Relatives">Overseas Filipino Workers (OFWs) and Their Families/Relatives</option>
                <option value="Entrepreneurs">Entrepreneurs</option>
                <option value="Indigenous Peoples">Indigenous Peoples</option>
                <option value="Farmers and Fisherfolk">Farmers and Fisherfolk</option>
                <option value="Government Employees & Public Servants">Government Employees & Public Servants</option>
                <option value="Micro, Small, and Medium Enterprises (MSMEs)">Micro, Small, and Medium Enterprises (MSMEs)</option>
                <option value="Health Workers & Medical Professionals">Health Workers & Medical Professionals</option>
                <option value="Transport & Logistics Workers">Transport & Logistics Workers</option>
                <option value="Informal Workers & Daily Wage Earners">Informal Workers & Daily Wage Earners</option>
            </select>
             <div class="error-message"></div>
         </div>

        <!-- 7. Experience Rating -->
        <div class="form-group">
             <label for="rating" class="form-label">Experience Rating <span class="required">*</span></label>
             <select id="rating" name="rating" required>
                 <option value="" disabled selected>Rate your experience</option>
                 <option value="5">Excellent (5)</option>
                 <option value="4">Very Good (4)</option>
                 <option value="3">Good (3)</option>
                 <option value="2">Fair (2)</option>
                 <option value="1">Poor (1)</option>
             </select>
              <div class="error-message"></div>
        </div>

        <!-- 8. Recommendations/Comments -->
        <div class="form-group">
             <label for="recommendations" class="form-label">Recommendations/Comments</label>
             <textarea id="recommendations" name="recommendations" rows="3" placeholder="Any suggestions or feedback? (Optional)"></textarea>
             <!-- No error message needed for optional field -->
        </div>

         <!-- 10. First Time Visit -->
        <div class="form-group first-visit-checkbox-group">
            <label>
                <!-- IMPORTANT: name attribute MUST match the Google Sheet header -->
                <input type="checkbox" name="is_first_visit" id="isFirstVisit" value="true">
                <span>This is my first visit</span>
            </label>
        </div>

        <!-- 9. Signature Data -->
        <div class="form-group signature-group">
            <label for="signatureCanvas" class="form-label">Signature <span class="required">*</span></label>
            <div class="canvas-container" id="canvasContainer">
               <canvas id="signatureCanvas"></canvas>
            </div>
             <button type="button" id="clearSignatureBtn" class="clear-btn">Clear Signature</button>
             <!-- IMPORTANT: name attribute MUST match the Google Sheet header -->
             <input type="hidden" id="signatureData" name="signatureData">
             <div id="sigError"></div>
        </div>

        <!-- Submit Button -->
        <button type="submit" id="submitButton" class="button-primary">Register Client</button> <!-- Added id -->

        <!-- Status Message Area -->
        <div id="formStatus"></div> <!-- Added this div -->

    </form>

  </div><!-- end .container -->

  <!-- 1. INCLUDE SIGNATURE PAD LIBRARY -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

  <!-- 2. CUSTOM JAVASCRIPT -->
  <script>
    // --- DOM Elements ---
    const form = document.getElementById('registrationForm');
    const servicesSelect = document.getElementById('services_availed');
    const otherServiceDiv = document.getElementById('other_service_div');
    const otherServiceInput = document.getElementById('other_service');
    const canvas = document.getElementById('signatureCanvas');
    const signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(253, 253, 253)'
    });
    const clearButton = document.getElementById('clearSignatureBtn');
    const signatureDataInput = document.getElementById('signatureData');
    const sigErrorDiv = document.getElementById('sigError');
    const canvasContainer = document.getElementById('canvasContainer');
    const submitButton = document.getElementById('submitButton');
    const formStatusDiv = document.getElementById('formStatus');

    // --- CONFIGURATION: Google Apps Script Web App URL ---
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbww5IncijGSykMP2tFHo8BDL2j7Cldq98VWc-QUzkpNx7t4iobSs7GscBQj7b1AJleN/exec'; // <<< URL INSERTED HERE
    // --------------------------------------------------

    // Basic check if URL seems valid (not a comprehensive check)
    if (!SCRIPT_URL || !SCRIPT_URL.startsWith('https://script.google.com/macros/s/')) {
        console.error("Configuration Error: The SCRIPT_URL seems invalid or is missing.");
        alert("Configuration Error: Script URL is missing or invalid. Form submission disabled.");
        submitButton.disabled = true;
        formStatusDiv.textContent = 'Configuration error: Invalid Script URL.';
        formStatusDiv.className = 'error';
    }

    // --- Helper: Debounce function ---
    function debounce(func, wait = 250, immediate = false) {
        let timeout;
        return function() {
            const context = this, args = arguments;
            const later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            const callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    }

    // --- Helper: Adjust canvas size ---
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const currentData = signaturePad.toDataURL(); // Save current drawing
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.fromDataURL(currentData); // Re-draw saved drawing
        clearSignatureError(); // Clear error state on resize
    }

    // --- Helper: Show/Hide Validation Error ---
    function showError(inputElement, message) {
        const errorDiv = inputElement.parentElement.querySelector('.error-message, #sigError'); // Target specific error divs
        if (errorDiv) {
            errorDiv.textContent = message;
        }
        // Add error border class
        if (inputElement.id === 'signatureCanvas') {
             canvasContainer.classList.add('error-border');
        } else if (inputElement) { // Ensure inputElement exists
             inputElement.classList.add('error-border');
        }
    }

    function clearError(inputElement) {
        const errorDiv = inputElement.parentElement.querySelector('.error-message, #sigError');
         if (errorDiv) {
             errorDiv.textContent = '';
         }
         // Remove error border class
         if (inputElement.id === 'signatureCanvas') {
             canvasContainer.classList.remove('error-border');
         } else if (inputElement) { // Ensure inputElement exists
             inputElement.classList.remove('error-border');
         }
    }

     function clearSignatureError() {
         canvasContainer.classList.remove('error-border');
         if(sigErrorDiv) sigErrorDiv.textContent = '';
     }

     function clearAllErrors() {
         const errorMessages = form.querySelectorAll('.error-message, #sigError');
         errorMessages.forEach(el => el.textContent = '');
         const errorBorders = form.querySelectorAll('.error-border');
         errorBorders.forEach(el => el.classList.remove('error-border'));
         if(formStatusDiv) {
             formStatusDiv.textContent = '';
             formStatusDiv.className = ''; // Clear status style class
         }
     }

    // --- Event Listeners ---

    // Adjust canvas on window resize (debounced)
    window.addEventListener("resize", debounce(resizeCanvas));

    // Clear Signature Button
    if(clearButton) {
        clearButton.addEventListener('click', () => {
            signaturePad.clear();
            if(signatureDataInput) signatureDataInput.value = ''; // Clear the hidden input as well
            clearSignatureError();
        });
    }

    // When user starts drawing, clear potential error message
     if(canvas) {
         canvas.addEventListener('pointerdown', (event) => {
             clearSignatureError(); // Clear error as soon as drawing starts
        });
         canvas.addEventListener('touchstart', (event) => {
             clearSignatureError();
         }, { passive: true });
     }


    // Toggle "Other Service" field visibility and requirement
    function toggleOtherService() {
        if (!servicesSelect || !otherServiceDiv || !otherServiceInput) return; // Add checks

        const selectedValue = servicesSelect.value;
        const otherErrorDiv = otherServiceInput.parentElement.querySelector('.error-message');

        if (selectedValue === 'Others') {
            otherServiceDiv.classList.remove('hidden');
            otherServiceInput.required = true; // Add required attribute dynamically
        } else {
            otherServiceDiv.classList.add('hidden');
            otherServiceInput.required = false; // Remove required attribute
            otherServiceInput.value = ''; // Clear the input value when hidden
            clearError(otherServiceInput); // Clear errors when hidden
        }
         clearError(servicesSelect); // Clear error on the select itself when changed
    }

    // Initial setup for Other Service field
    document.addEventListener('DOMContentLoaded', () => {
        toggleOtherService(); // Run on load
        // Small delay for initial canvas resize
        setTimeout(resizeCanvas, 100);
    });
    // Add listener to the select dropdown
    if(servicesSelect) {
        servicesSelect.addEventListener('change', toggleOtherService);
    }


    // --- Form Submission Handler ---
    function handleSubmit(event) {
        event.preventDefault(); // Prevent default page reload

        // Ensure critical elements exist before proceeding
        if (!form || !submitButton || !formStatusDiv || !signaturePad || !signatureDataInput || !canvas) {
            console.error("Form element(s) missing, cannot submit.");
            alert("A critical form component is missing. Please reload the page.");
            return false;
        }

        let isValid = true;
        clearAllErrors(); // Clear previous errors and status

        // --- 1. Basic HTML5 Validation & Custom Required Messages ---
        const requiredInputs = form.querySelectorAll('input[required], select[required]');
        requiredInputs.forEach(input => {
            clearError(input); // Clear previous error first
            if (!input.checkValidity()) {
                isValid = false;
                let message = 'This field is required.'; // Default required message
                 if (input.validity.rangeUnderflow) {
                     message = `Age must be at least ${input.min}.`;
                 } else if(input.validity.rangeOverflow) {
                     message = `Age must be no more than ${input.max}.`;
                 } else if (input.validity.valueMissing && input.tagName === 'SELECT') {
                    message = 'Please select an option.';
                 }
                showError(input, message);
            }
        });

        // --- 2. Custom Validation: "Other Service" ---
        if (servicesSelect && servicesSelect.value === 'Others') {
             if (otherServiceInput) {
                clearError(otherServiceInput); // Clear first
                if (!otherServiceInput.value || otherServiceInput.value.trim() === '') {
                    isValid = false;
                    showError(otherServiceInput, 'Please specify the service.');
                }
            }
        }

        // --- 3. Custom Validation: Signature ---
        clearSignatureError(); // Clear previous signature error
        if (signaturePad.isEmpty()) {
            isValid = false;
            showError(canvas, 'Signature is required.'); // Use canvas element for showError context
        } else {
            // Signature is present, store data URL in the hidden input
            // Will be done just before sending if form is valid
        }


        // --- Final Check & Submission ---
        if (isValid) {

             // Ensure signature data is set one last time right before creating FormData
             if (!signaturePad.isEmpty()) {
                 signatureDataInput.value = signaturePad.toDataURL('image/png');
             } else {
                 // This case should ideally not be reached due to validation above, but as a safeguard:
                 console.error("Signature became empty unexpectedly before submission.");
                 showError(canvas, 'Signature is required.');
                 formStatusDiv.textContent = 'Please fix the errors above.';
                 formStatusDiv.className = 'error';
                 if (canvasContainer) canvasContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 return false; // Stop submission
             }

            // Disable button and show submitting message
            submitButton.disabled = true;
            formStatusDiv.textContent = 'Submitting... Please wait.';
            formStatusDiv.className = 'submitting'; // Add class for styling

            // Create FormData object from the form
            const formData = new FormData(form);

            // --- Optional: Log data to console (for debugging) ---
            console.log("--- Sending Data to Google Sheet ---");
            for (let [key, value] of formData.entries()) {
                if (key === 'signatureData' && typeof value === 'string' && value.length > 100) {
                   console.log(`${key}: [Signature Data Present - Length: ${value.length}]`);
                } else {
                   console.log(`${key}: ${value}`);
                }
            }
            console.log("Target URL:", SCRIPT_URL);
            // -----------------------------------------


            // --- Send data to Google Apps Script ---
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData,
                mode: 'cors' // Standard mode for cross-origin requests expecting a response
            })
            .then(response => {
                if (!response.ok) {
                     // Try to get error text from response if possible
                     return response.text().then(text => {
                         // Check for specific Google Script errors (like redirection)
                         if (response.type === 'opaque' || text.includes('<title>Google Apps Script</title>')) {
                              throw new Error(`Script execution failed or redirected. Check script deployment settings (needs 'Anyone' access) and permissions.`);
                         }
                         throw new Error(`Network error: ${response.status} ${response.statusText}. Server: ${text || 'No details'}`);
                     });
                }
                return response.json(); // Expect JSON response from Apps Script
            })
            .then(data => {
                console.log('Success Response from Google Script:', data);
                if (data && data.result === "success") {
                    formStatusDiv.textContent = 'Registration Submitted Successfully!';
                    formStatusDiv.className = 'success'; // Add class for styling
                    form.reset(); // Reset form fields
                    signaturePad.clear(); // Clear signature canvas
                    signatureDataInput.value = ''; // **Important:** Clear hidden signature data after successful submit
                    clearAllErrors(); // Clear any lingering visual error styles
                    toggleOtherService(); // Ensure 'others' field is hidden again

                    // Optionally clear the success message after a delay
                    setTimeout(() => {
                         if (formStatusDiv && formStatusDiv.textContent.includes('Successfully')) {
                             formStatusDiv.textContent = '';
                             formStatusDiv.className = '';
                         }
                    }, 5000); // Clear after 5 seconds

                } else {
                    // Handle specific error reported by the Apps Script or unexpected response format
                    throw new Error(data ? (data.message || JSON.stringify(data)) : 'Invalid response format from script.');
                }
            })
            .catch((error) => {
                console.error('Error during submission:', error);
                formStatusDiv.textContent = `Error: ${error.message || 'Could not submit form. Check console.'}`;
                formStatusDiv.className = 'error';
            })
            .finally(() => {
                // Re-enable button regardless of success or error
                submitButton.disabled = false;
            });

        } else {
            console.log('Form validation failed.');
            formStatusDiv.textContent = 'Please fix the errors above.';
            formStatusDiv.className = 'error'; // Add class for styling
            // Scroll to the first error
            const firstError = form.querySelector('.error-border');
            if (firstError) {
                 // Find the element to scroll to (input/select/textarea or canvas container)
                 const scrollTarget = firstError.closest('.form-group') || firstError;
                 if (scrollTarget) scrollTarget.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return false; // Prevent submission if validation fails
        }
         return false; // Explicitly return false as we handle submission via fetch
    }

    // Removed DOMContentLoaded listener for toggleOtherService/resizeCanvas as they are called elsewhere now.
    // Initial canvas resize added to DOMContentLoaded handler at the end of the script for better timing.
     document.addEventListener('DOMContentLoaded', () => {
         // Small delay to ensure layout is final before first resize
        setTimeout(resizeCanvas, 100);
        // Initial check for 'Others' field state
        toggleOtherService();
    });

  </script>

</body>
</html>
